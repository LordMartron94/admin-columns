<script lang="ts">
    import {currentListKey} from "../store/current-list-screen";
    import {createEventDispatcher, onMount} from "svelte";
    import GroupIcon from "./GroupIcon.svelte";
    import {SvelteSelectItem} from "../../types/select";
    import Select from "svelte-select";
    import {favoriteListKeysStore} from "../store/favorite-listkeys";
    import ListScreenMenuItem from "./ListScreenMenuItem.svelte";

    export let menu: AC.Vars.Admin.Columns.MenuItems;

    const dispatch = createEventDispatcher();

    let openedGroups: string[] = [];
    let options: SvelteSelectItem[];
    let selectValue = '';
    let favorites: string[] = [];
    let favoriteItems: { [key: string]: string } = {}

    const handleMenuSelect = (key: string) => {
        dispatch('itemSelect', key)
    }

    const handleSelect = (e: CustomEvent<SvelteSelectItem>) => {
        handleMenuSelect(e.detail.value.toString());
    }

    const toggleGroup = (group: string) => {
        openedGroups.includes(group)
            ? closeGroup(group)
            : showGroup(group);
    }

    const showGroup = (group: string) => {
        openedGroups.push(group);
        openedGroups = openedGroups;
    }

    const closeGroup = (group: string) => {
        openedGroups = openedGroups.filter(d => d !== group);
    }


    const mapMenuToSelect = (menu: AC.Vars.Admin.Columns.MenuItems): SvelteSelectItem[] => {
        let result: SvelteSelectItem[] = [];

        Object.values(menu).forEach(group => {
            for (const [value, label] of Object.entries(group.options)) {
                result.push({
                    value,
                    label,
                    group: group.title
                });
            }
        });

        selectValue = $currentListKey;

        return result;
    }

    const groupBy = (item: SvelteSelectItem) => item.group;

    const refreshFavoriteItems = () => {
        let _favoriteItems: { [key: string]: string } = {};

        Object.values(menu).forEach(group => {
            for (const [value, label] of Object.entries(group.options)) {
                if ($favoriteListKeysStore.includes(value)) {
                    _favoriteItems[value] = label;
                }
            }
        });

        favoriteItems = _favoriteItems;
    }

    favoriteListKeysStore.subscribe(() => {
        refreshFavoriteItems()
    })

    onMount(() => {
        for (const [key, group] of Object.entries(menu)) {
            if (group.options.hasOwnProperty($currentListKey)) {
                showGroup(key);
            }
        }
        options = mapMenuToSelect(menu);
    })
</script>
<nav class="ac-table-screen-nav">
	<div class="ac-table-screen-nav__select">
		<Select
			bind:value={selectValue}
			items={options}
			{groupBy}
			class="-acui"
			placeholder="Select"
			clearable={false}
			showChevron
			on:input={handleSelect }>

		</Select>
	</div>
	<div class="ac-table-screen-nav__list">

		{#if Object.keys( favoriteItems ).length > 0}
			<div class="ac-menu-group">
				<button class="ac-menu-group__header">
					<GroupIcon icon="dashicons-star-empty" defaultIcon="cpacicon-gf-article"></GroupIcon>
					Favorites
				</button>
				<ul class="ac-menu-group-list">
					{#each Object.entries( favoriteItems ) as [ key, label ]}
						<ListScreenMenuItem
							{key}
							{label}
							on:selectItem={ () => selectValue = key}
						/>
					{/each}
				</ul>
			</div>
		{/if}

		{#each Object.entries( menu ) as [ key, group ]}
			<div class="ac-menu-group">
				<button on:click={()=>toggleGroup(key)} class="ac-menu-group__header"
					class:closed={!openedGroups.includes( key )}>
					<GroupIcon icon={group.icon} defaultIcon="cpacicon-gf-article"></GroupIcon>
					{group.title}
					<span class="ac-menu-group__header__indicator dashicons dashicons-arrow-up-alt2"></span>
				</button>
				{#if openedGroups.includes( key )}
					<ul class="ac-menu-group-list">
						{#each Object.entries( group.options ) as [ key, label ]}
							<ListScreenMenuItem
								{key}
								{label}
								on:selectItem={ () => selectValue = key}
							/>
						{/each}
					</ul>
				{/if}
			</div>
		{/each}
	</div>
</nav>